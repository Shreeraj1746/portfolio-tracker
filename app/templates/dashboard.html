{% extends "base.html" %}

{% block content %}
<section class="grid two-col">
  <div class="panel">
    <h2>Add Group</h2>
    <form method="post" action="/groups" class="form-grid compact">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      <label>
        Group name
        <input type="text" name="name" required placeholder="stonks" />
      </label>
      <button type="submit">Create Group</button>
    </form>

    <h2>Add Asset</h2>
    <form method="post" action="/assets" class="form-grid compact" id="assetCreateForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      <label>
        Symbol
        <input type="text" name="symbol" required placeholder="AAPL / BTC-USD / HOUSE" />
      </label>
      <label>
        Name
        <input type="text" name="name" required placeholder="Apple Inc." />
      </label>
      <label>
        Type
        <select name="asset_type" id="assetTypeSelect">
          <option value="market">Market</option>
          <option value="manual">Manual</option>
        </select>
      </label>
      <label>
        Group
        <select name="group_id" required>
          <option value="">Select group</option>
          {% for group in groups %}
            <option value="{{ group.id }}">{{ group.name }}</option>
          {% endfor %}
        </select>
      </label>

      <p class="hint" data-asset-type-note="market">
        Market: Price auto-fetched, value = shares x price. Buy price can be negative for adjusted cost basis.
      </p>
      <p class="hint hidden" data-asset-type-note="manual">
        Manual: Value set manually (real estate, private), no live price.
      </p>

      <label data-asset-create-field="market">
        Initial shares (optional)
        <input type="number" step="0.000001" min="0" name="initial_quantity" placeholder="0" />
      </label>
      <label data-asset-create-field="market">
        Initial buy price/share (USD)
        <input type="number" step="0.0001" name="initial_buy_price" placeholder="0 (can be negative)" />
      </label>
      <label data-asset-create-field="market">
        Initial fees (optional)
        <input type="number" step="0.01" min="0" name="initial_fees" placeholder="0" />
      </label>

      <label class="hidden" data-asset-create-field="manual">
        Initial current value (USD)
        <input type="number" step="0.01" min="0" name="initial_value" placeholder="10000" />
      </label>
      <label class="hidden" data-asset-create-field="manual">
        Initial invested / cost basis (optional USD)
        <input type="number" step="0.01" min="0" name="initial_invested" placeholder="7500" />
      </label>

      <button type="submit">Create Asset</button>
    </form>
  </div>

  <div class="panel">
    <h2>Allocation By Group</h2>
    <p id="allocationByGroupEmpty" class="muted {% if has_group_allocation %}hidden{% endif %}">
      No holdings to chart yet.
    </p>
    <div class="chart-wrap small">
      <canvas id="allocationByGroupChart" {% if not has_group_allocation %}class="hidden"{% endif %}></canvas>
    </div>

    <h2>Allocation By Asset</h2>
    <p id="allocationByAssetEmpty" class="muted {% if has_asset_allocation %}hidden{% endif %}">
      No holdings to chart yet.
    </p>
    <div class="chart-wrap small">
      <canvas id="allocationByAssetChart" {% if not has_asset_allocation %}class="hidden"{% endif %}></canvas>
    </div>
  </div>
</section>

<section class="panel">
  <h2>Portfolio Value (USD)</h2>
  <form method="get" action="/" class="form-grid compact inline-range-form chart-range-form">
    <label>
      Start date
      <input type="date" name="chart_start" value="{{ chart_start }}" />
    </label>
    <label>
      End date
      <input type="date" name="chart_end" value="{{ chart_end }}" />
    </label>
    <button type="submit">Apply Range</button>
  </form>
  {% if portfolio_series_error %}
    <p id="portfolioSeriesError" class="muted">{{ portfolio_series_error }}</p>
  {% endif %}
  {% if portfolio_series_missing_symbols %}
    <p class="muted">Missing history for: {{ portfolio_series_missing_symbols|join(", ") }}</p>
  {% endif %}
  <div class="chart-wrap small">
    <canvas id="portfolioChart" {% if not has_portfolio_series %}class="hidden"{% endif %}></canvas>
  </div>
</section>

<section class="panel">
  <h2>Portfolio Unrealized PnL (USD)</h2>
  {% if pnl_series_error %}
    <p id="pnlSeriesError" class="muted">{{ pnl_series_error }}</p>
  {% endif %}
  {% if pnl_series_missing_symbols %}
    <p class="muted">Missing history for: {{ pnl_series_missing_symbols|join(", ") }}</p>
  {% endif %}
  <div class="checkbox-list full-width" id="pnlAssetSelectors">
    <strong>PnL asset selectors</strong>
    <p class="muted">Basket members are de-duplicated: only basket overlay rows are selectable.</p>
    {% for label in pnl_selector_labels %}
      <label class="checkbox-inline">
        <input type="checkbox" class="pnl-asset-selector" value="{{ label }}" checked />
        {{ label }}
      </label>
    {% else %}
      <p class="muted">No assets available for PnL chart.</p>
    {% endfor %}
  </div>
  <p id="pnlSelectionEmpty" class="muted hidden">Select at least one asset or basket.</p>
  <div class="chart-wrap small">
    <canvas id="pnlChart" {% if not has_pnl_series %}class="hidden"{% endif %}></canvas>
  </div>
</section>

<section class="panel">
  <h2>Positions</h2>
  <table class="data-table" id="positionsTable">
    <thead>
      <tr>
        <th>Symbol / Name</th>
        <th>Group</th>
        <th>Quantity</th>
        <th>Avg Cost</th>
        <th>Current Price</th>
        <th>As Of</th>
        <th>Current Value</th>
        <th>Unrealized PnL</th>
        <th>Allocation %</th>
      </tr>
    </thead>
    <tbody>
      {% for group_name, rows in canonical_grouped_positions.items() %}
        {% for row in rows %}
          <tr
            class="asset-row"
            data-asset-id="{{ row.asset_id }}"
            data-symbol="{{ row.symbol }}"
            data-group="{{ row.group_name }}"
            data-asset-type="{{ row.asset_type.value }}"
            data-row-kind="{{ row.row_kind }}"
            data-quantity="{{ row.quantity if row.quantity is not none else '' }}"
            data-avg-cost="{{ row.avg_cost if row.avg_cost is not none else '' }}"
            data-current-value="{{ row.current_value }}"
            data-current-pnl="{{ row.unrealized_pnl if row.unrealized_pnl is not none else '' }}"
            data-as-of-iso="{{ row.as_of.isoformat() if row.as_of else '' }}"
            data-in-basket-member="{{ 1 if row.in_basket_member else 0 }}"
            data-chart-label="{{ row.name if row.row_kind == 'basket' else row.symbol }}"
            data-counts-in-totals="{{ 1 if row.counts_in_totals else 0 }}"
            data-counts-in-allocation="{{ 1 if row.counts_in_allocation else 0 }}"
            data-valuation-scope="{{ row.valuation_scope }}"
            data-basket-member-ids=""
          >
            <td>
              <a href="{{ row.detail_path }}">{{ row.symbol }}</a>
              <span class="muted">{{ row.name }}</span>
              {% if row.row_kind == "asset" %}
                <a class="tiny-link" href="/assets/{{ row.asset_id }}/edit">Edit</a>
              {% endif %}
              {% if row.display_badge %}
                <span class="badge">{{ row.display_badge }}</span>
              {% endif %}
            </td>
            <td>{{ row.group_name }}</td>
            <td class="quantity-cell">{{ row.quantity|number(6) if row.quantity is not none else "-" }}</td>
            <td class="avg-cost-cell">{{ row.avg_cost|currency if row.avg_cost is not none else "-" }}</td>
            <td class="current-price {{ 'stale' if row.quote_stale else '' }}">{{ row.current_price|currency if row.current_price is not none else "-" }}</td>
            <td class="as-of">{{ row.as_of|dt if row.as_of else "-" }}</td>
            <td class="current-value">{{ row.current_value|currency }}</td>
            <td class="pnl {{ 'positive' if (row.unrealized_pnl or 0) >= 0 else 'negative' }}">
              {{ row.unrealized_pnl|currency if row.unrealized_pnl is not none else "-" }}
            </td>
            <td class="allocation">{{ row.allocation_pct|pct }}</td>
          </tr>
        {% endfor %}
        <tr class="group-subtotal" data-group-subtotal="{{ group_name }}">
          <td colspan="6"><strong>{{ group_name }} subtotal</strong></td>
          <td class="group-value">{{ canonical_group_totals[group_name]["value"]|currency }}</td>
          <td class="group-pnl {{ 'positive' if canonical_group_totals[group_name]['pnl'] >= 0 else 'negative' }}">{{ canonical_group_totals[group_name]["pnl"]|currency }}</td>
          <td></td>
        </tr>
      {% endfor %}

      {% if derived_positions %}
        <tr class="section-separator">
          <td colspan="9"><strong>Derived Baskets (excluded from canonical totals)</strong></td>
        </tr>
        {% for row in derived_positions %}
          <tr
            class="asset-row derived-row"
            data-asset-id="{{ row.asset_id }}"
            data-symbol="{{ row.symbol }}"
            data-group="{{ row.group_name }}"
            data-asset-type="{{ row.asset_type.value }}"
            data-row-kind="{{ row.row_kind }}"
            data-quantity="{{ row.quantity if row.quantity is not none else '' }}"
            data-avg-cost="{{ row.avg_cost if row.avg_cost is not none else '' }}"
            data-current-value="{{ row.current_value }}"
            data-current-pnl="{{ row.unrealized_pnl if row.unrealized_pnl is not none else '' }}"
            data-as-of-iso="{{ row.as_of.isoformat() if row.as_of else '' }}"
            data-in-basket-member="{{ 1 if row.in_basket_member else 0 }}"
            data-chart-label="{{ row.name if row.row_kind == 'basket' else row.symbol }}"
            data-counts-in-totals="{{ 1 if row.counts_in_totals else 0 }}"
            data-counts-in-allocation="{{ 1 if row.counts_in_allocation else 0 }}"
            data-valuation-scope="{{ row.valuation_scope }}"
            data-basket-member-ids="{{ row.basket_member_ids|join(',') if row.basket_member_ids else '' }}"
          >
            <td>
              <a href="{{ row.detail_path }}">{{ row.symbol }}</a>
              <span class="muted">{{ row.name }}</span>
              {% if row.display_badge %}
                <span class="badge">{{ row.display_badge }}</span>
              {% endif %}
            </td>
            <td>{{ row.group_name }}</td>
            <td class="quantity-cell">{{ row.quantity|number(6) if row.quantity is not none else "-" }}</td>
            <td class="avg-cost-cell">{{ row.avg_cost|currency if row.avg_cost is not none else "-" }}</td>
            <td class="current-price {{ 'stale' if row.quote_stale else '' }}">{{ row.current_price|currency if row.current_price is not none else "-" }}</td>
            <td class="as-of">{{ row.as_of|dt if row.as_of else "-" }}</td>
            <td class="current-value">{{ row.current_value|currency }}</td>
            <td class="pnl {{ 'positive' if (row.unrealized_pnl or 0) >= 0 else 'negative' }}">
              {{ row.unrealized_pnl|currency if row.unrealized_pnl is not none else "-" }}
            </td>
            <td class="allocation">-</td>
          </tr>
        {% endfor %}
        <tr class="group-subtotal derived-subtotal" data-derived-subtotal="baskets">
          <td colspan="6"><strong>Derived baskets subtotal</strong></td>
          <td id="derivedTotalValue">{{ derived_total_value|currency }}</td>
          <td id="derivedTotalPnl" class="{{ 'positive' if derived_total_unrealized_pnl >= 0 else 'negative' }}">{{ derived_total_unrealized_pnl|currency }}</td>
          <td></td>
        </tr>
      {% endif %}
    </tbody>
    <tfoot>
      <tr class="grand-total">
        <td colspan="6"><strong>Grand Total (Canonical)</strong></td>
        <td id="grandTotalValue">{{ canonical_total_value|currency }}</td>
        <td id="grandTotalPnl" class="{{ 'positive' if canonical_total_unrealized_pnl >= 0 else 'negative' }}">{{ canonical_total_unrealized_pnl|currency }}</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</section>
{% endblock %}

{% block scripts %}
<script>
  window.PORTFOLIO_DASHBOARD = {
    symbols: {{ market_symbols|tojson }},
    groupAllocationLabels: {{ group_allocation_labels|tojson }},
    groupAllocationValues: {{ group_allocation_values|tojson }},
    groupAllocationPercentages: {{ group_allocation_percentages|tojson }},
    assetAllocationLabels: {{ asset_allocation_labels|tojson }},
    assetAllocationValues: {{ asset_allocation_values|tojson }},
    assetAllocationPercentages: {{ asset_allocation_percentages|tojson }},
    portfolioSeriesLabels: {{ portfolio_series_labels|tojson }},
    portfolioSeriesValues: {{ portfolio_series_values|tojson }},
    pnlSeriesLabels: {{ pnl_series_labels|tojson }},
    pnlSeriesByAsset: {{ pnl_series_by_asset|tojson }}
  };
</script>
{% endblock %}
