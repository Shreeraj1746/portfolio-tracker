{% extends "base.html" %}

{% block content %}
<section class="panel">
  <div class="title-row">
    <h1>{{ asset.symbol }} <span class="muted">{{ asset.name }}</span></h1>
    <div class="actions-row">
      <a href="/assets/{{ asset.id }}/edit">Edit Asset</a>
      {% if can_delete_asset %}
      <form method="post" action="/assets/{{ asset.id }}/delete" class="inline-form" onsubmit="return confirm('Delete this asset?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <button type="submit" class="button-link danger">Delete</button>
      </form>
      {% else %}
      <form method="post" action="/assets/{{ asset.id }}/archive" class="inline-form" onsubmit="return confirm('Archive this asset?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <button type="submit" class="button-link">Archive</button>
      </form>
      {% endif %}
    </div>
  </div>

  <p class="muted">
    {% if asset.asset_type.value == 'market' %}
      Market: Price auto-fetched, value = shares x price.
    {% else %}
      Manual: Value set manually (real estate, private), no live price.
    {% endif %}
  </p>

  {% if asset.is_archived %}
    <p class="muted">This asset is archived and excluded from dashboard and basket pickers.</p>
  {% endif %}

  <div class="summary-grid">
    <div><strong>Group:</strong> {{ asset.group.name if asset.group else "Ungrouped" }}</div>
    <div><strong>Type:</strong> {{ asset.asset_type.value }}</div>
    <div><strong>Quantity:</strong> {{ summary.quantity|number(6) if summary.quantity is not none else "-" }}</div>
    <div><strong>Avg Cost / Invested:</strong> {{ summary.avg_cost|currency if summary.avg_cost is not none else "-" }}</div>
    <div><strong>Current Price:</strong> {{ summary.current_price|currency if summary.current_price is not none else "-" }}</div>
    <div><strong>Current Value:</strong> {{ summary.current_value|currency }}</div>
    <div><strong>Unrealized PnL:</strong> {{ summary.unrealized_pnl|currency if summary.unrealized_pnl is not none else "-" }}</div>
    <div><strong>As Of:</strong> {{ summary.as_of|dt if summary.as_of else "-" }}</div>
  </div>
</section>

<section class="panel">
  <h2>Performance</h2>
  {% if can_chart %}
    <div class="chart-wrap">
      <canvas id="assetChart"></canvas>
    </div>
  {% else %}
    <p class="muted">No chart data available for this asset right now.</p>
  {% endif %}
</section>

<section class="panel">
  <h2>Add Transaction</h2>
  <form method="post" action="/assets/{{ asset.id }}/transactions" class="form-grid" id="transactionForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <label>
      Type
      <select name="type" id="txType" required>
        {% for tx_type in tx_types %}
          <option value="{{ tx_type }}">{{ tx_type }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Timestamp
      <input type="datetime-local" name="timestamp" value="{{ default_timestamp }}" required />
    </label>
    <label data-field="quantity">
      Quantity
      <input type="number" step="0.000001" name="quantity" />
    </label>
    <label data-field="price">
      Price
      <input type="number" step="0.0001" name="price" />
    </label>
    <label>
      Fees
      <input type="number" step="0.0001" name="fees" value="0" />
    </label>
    <label data-field="manual_value">
      Manual value
      <input type="number" step="0.01" name="manual_value" />
    </label>
    <label class="full-width">
      Note
      <input type="text" name="note" placeholder="Optional note" />
    </label>
    <button type="submit">Add Transaction</button>
  </form>
</section>

<section class="panel">
  <h2>Transactions</h2>
  <table class="data-table">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Type</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Fees</th>
        <th>Manual Value</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions %}
        <tr>
          <td>{{ tx.timestamp|dt }}</td>
          <td>{{ tx.type.value }}</td>
          <td>{{ tx.quantity|number(6) if tx.quantity is not none else '-' }}</td>
          <td>{{ tx.price|currency if tx.price is not none else '-' }}</td>
          <td>{{ tx.fees|currency }}</td>
          <td>{{ tx.manual_value|currency if tx.manual_value is not none else '-' }}</td>
          <td>{{ tx.note or '-' }}</td>
          <td class="actions">
            <a href="/assets/{{ asset.id }}/transactions/{{ tx.id }}/edit">Edit</a>
            <form method="post" action="/assets/{{ asset.id }}/transactions/{{ tx.id }}/delete" class="inline-form" onsubmit="return confirm('Delete this transaction?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button type="submit" class="button-link">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}

{% block scripts %}
<script>
  window.ASSET_CHART = {
    labels: {{ chart_labels_json|safe }},
    values: {{ chart_values_json|safe }}
  };
</script>
{% endblock %}
